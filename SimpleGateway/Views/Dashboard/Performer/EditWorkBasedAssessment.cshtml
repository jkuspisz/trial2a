@model SimpleGateway.Models.WorkBasedAssessmentModel
@{
    ViewData["Title"] = "Edit Work Based Assessment";
    ViewBag.ActiveSection = "WorkBasedAssessments";
}

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar Navigation -->
        <div class="col-md-3">
            <ul class="list-group">
                <li class="list-group-item @(ViewBag.ActiveSection == "Dashboard" ? "active" : "")">
                    <a href="/Dashboard/ViewPerformerDashboard?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "Dashboard" ? "color: white;" : "")">
                        <i class="bi bi-speedometer2"></i> Dashboard Overview
                    </a>
                </li>
                <li class="list-group-item @(ViewBag.ActiveSection == "PerformerDetails" ? "active" : "")">
                    <a href="/Dashboard/PerformerDetails?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "PerformerDetails" ? "color: white;" : "")">Performer Details</a>
                </li>
                <li class="list-group-item @(ViewBag.ActiveSection == "TestPractice" ? "active" : "")">
                    <a href="/Dashboard/TestPractice?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "TestPractice" ? "color: white;" : "")">Test Practice</a>
                </li>
                <li class="list-group-item @(ViewBag.ActiveSection == "TestPractice2" ? "active" : "")">
                    <a href="/Dashboard/TestPractice2?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "TestPractice2" ? "color: white;" : "")">Test Practice 2</a>
                </li>
                <li class="list-group-item @(ViewBag.ActiveSection == "Uploads" ? "active" : "")">
                    <a href="/Dashboard/Uploads?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "Uploads" ? "color: white;" : "")">Uploads</a>
                </li>
                <li class="list-group-item @(ViewBag.ActiveSection == "StructuredConversation" ? "active" : "")">
                    <a href="/Dashboard/StructuredConversation?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "StructuredConversation" ? "color: white;" : "")">Structured Conversation</a>
                </li>
                <li class="list-group-item @(ViewBag.ActiveSection == "AgreementTerms" ? "active" : "")">
                    <a href="/Dashboard/AgreementTerms?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "AgreementTerms" ? "color: white;" : "")">Agreement Terms</a>
                </li>
                <li class="list-group-item @(ViewBag.ActiveSection == "WorkBasedAssessments" ? "active" : "")">
                    <a href="/Dashboard/WorkBasedAssessments?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "WorkBasedAssessments" ? "color: white;" : "")">Work Based Assessments</a>
                </li>
                <li class="list-group-item @(ViewBag.ActiveSection == "CPD" ? "active" : "")">
                    <a href="/Dashboard/CPD?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "CPD" ? "color: white;" : "")">CPD</a>
                </li>
                <li class="list-group-item @(ViewBag.ActiveSection == "MSF" ? "active" : "")">
                    <a href="@Url.Action("Index", "MSF")" style="@(ViewBag.ActiveSection == "MSF" ? "color: white;" : "")">
                        <i class="fas fa-comments"></i> MSF Assessment
                    </a>
                </li>
                <li class="list-group-item @(ViewBag.ActiveSection == "PSQ" ? "active" : "")">
                    <a href="/Dashboard/PSQ?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "PSQ" ? "color: white;" : "")">PSQ</a>
                </li>
                <li class="list-group-item @(ViewBag.ActiveSection == "ClinicalNoteAudit" ? "active" : "")">
                    <a href="/Dashboard/ClinicalNoteAudit?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "ClinicalNoteAudit" ? "color: white;" : "")">Clinical Note Audit</a>
                </li>
                <li class="list-group-item @(ViewBag.ActiveSection == "HelpGuidance" ? "active" : "")">
                    <a href="/Dashboard/HelpGuidance?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "HelpGuidance" ? "color: white;" : "")">Help & Guidance</a>
                </li>
                <li class="list-group-item @(ViewBag.ActiveSection == "FinalSignOff" ? "active" : "")">
                    <a href="/Dashboard/FinalSignOff?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "FinalSignOff" ? "color: white;" : "")">Final Sign off</a>
                </li>
                @if (ViewBag.IsOwnDashboard == true)
                {
                    <li class="list-group-item"><a href="/Account/Logout">Logout</a></li>
                }
                else
                {
                    <li class="list-group-item"><a href="/Dashboard/Index">Back to List</a></li>
                }
            </ul>
        </div>

        <!-- Main Content Area -->
        <div class="col-md-9">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3>@Model.AssessmentType Assessment - @ViewBag.PerformerName</h3>
                            <span class="badge bg-@Model.GetStatusColor()">@Model.GetDisplayStatus()</span>
                        </div>
                        <a href="/Dashboard/WorkBasedAssessments?performerUsername=@ViewBag.PerformerUsername" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Back to List
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Success/Error Messages -->
                    @if (TempData["SuccessMessage"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            @TempData["SuccessMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }
                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            @TempData["ErrorMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    <!-- PERFORMER SECTION -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="bi bi-person"></i> Performer Section</h5>
                        </div>
                        <div class="card-body">
                            @if (ViewBag.CanEditPerformer && !Model.IsPerformerSubmitted)
                            {
                                <!-- Editable Performer Form -->
                                <form method="post" action="/Dashboard/UpdatePerformerAssessment">
                                    <input type="hidden" asp-for="Id" />
                                    <input type="hidden" asp-for="Username" />
                                    <input type="hidden" asp-for="AssessmentType" />
                                    <input type="hidden" asp-for="Title" />

                                    <div class="row mb-3">
                                        <div class="col-md-12">
                                            <label asp-for="AssessmentDate" class="form-label">Date of Assessment</label>
                                            <input asp-for="AssessmentDate" class="form-control" type="text" 
                                                   placeholder="e.g., 2025-07-29 or July 29, 2025" 
                                                   value="@(Model.AssessmentDate?.ToString("yyyy-MM-dd"))" />
                                            <small class="form-text text-muted">Enter date in YYYY-MM-DD format</small>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label asp-for="ProcedureDescription" class="form-label">Description of Procedure/Case</label>
                                        <textarea asp-for="ProcedureDescription" class="form-control" rows="4" 
                                                  placeholder="Describe the procedure, case, or clinical scenario in detail..."
                                                  readonly="@(!ViewBag.CanEditPerformer)"></textarea>
                                    </div>

                                    <div class="mb-3">
                                        <label asp-for="LearningReflection" class="form-label">What did you learn from this encounter? - What do you think you did well? What could have gone better?</label>
                                        <textarea asp-for="LearningReflection" class="form-control" rows="5"
                                                  placeholder="Reflect on your learning from this encounter. What aspects went well and what areas could be improved?"
                                                  readonly="@(!ViewBag.CanEditPerformer)"></textarea>
                                    </div>

                                    <div class="mb-3">
                                        <label asp-for="LearningNeeds" class="form-label">What (if any) learning needs does this encounter highlight for you?</label>
                                        <textarea asp-for="LearningNeeds" class="form-control" rows="4"
                                                  placeholder="Identify any specific learning needs or areas for further development highlighted by this encounter..."
                                                  readonly="@(!ViewBag.CanEditPerformer)"></textarea>
                                    </div>

                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-save"></i> Save
                                        </button>
                                        <button type="submit" name="isSubmission" value="true" class="btn btn-success" 
                                                onclick="return confirm('Are you sure you want to submit this assessment? You will not be able to edit it after submission.')">
                                            <i class="bi bi-check-circle"></i> Submit
                                        </button>
                                    </div>
                                </form>

                                <script>
                                    // DEBUG: Add event listeners to detect form field changes
                                    document.addEventListener('DOMContentLoaded', function() {
                                        const assessmentDateInput = document.querySelector('input[name="AssessmentDate"]');
                                        const allInputs = document.querySelectorAll('input[type="text"], textarea');
                                        
                                        if (assessmentDateInput) {
                                            assessmentDateInput.addEventListener('change', function() {
                                                console.log('DEBUG: AssessmentDate changed to:', this.value);
                                                
                                                // Check if any other fields got cleared
                                                setTimeout(() => {
                                                    allInputs.forEach(input => {
                                                        if (input !== assessmentDateInput && input.value === '') {
                                                            console.log('WARNING: Field was cleared:', input.name || input.id);
                                                        }
                                                    });
                                                }, 100);
                                            });
                                        }
                                    });
                                </script>
                            }
                            else
                            {
                                <!-- Read-only Performer Section -->
                                <div class="mb-3">
                                    <strong>Date of Assessment:</strong>
                                    <p>@(Model.AssessmentDate?.ToString("MMMM dd, yyyy") ?? "Not specified")</p>
                                </div>

                                <div class="mb-3">
                                    <strong>Description of Procedure/Case:</strong>
                                    <p class="border p-3 bg-light">@(Model.ProcedureDescription ?? "Not provided")</p>
                                </div>

                                <div class="mb-3">
                                    <strong>What did you learn from this encounter? - What do you think you did well? What could have gone better?</strong>
                                    <p class="border p-3 bg-light">@(Model.LearningReflection ?? "Not provided")</p>
                                </div>

                                <div class="mb-3">
                                    <strong>What (if any) learning needs does this encounter highlight for you?</strong>
                                    <p class="border p-3 bg-light">@(Model.LearningNeeds ?? "Not provided")</p>
                                </div>

                                @if (Model.IsPerformerSubmitted)
                                {
                                    <div class="alert alert-success">
                                        <i class="bi bi-check-circle"></i> 
                                        Submitted by performer on @Model.PerformerSubmittedAt?.ToString("MMMM dd, yyyy 'at' h:mm tt")
                                    </div>
                                }
                            }
                        </div>
                    </div>

                    <!-- SUPERVISOR SECTION - Following Field-Level Permissions Pattern EXACTLY like TestPractice2 -->
                    <form method="post" action="/Dashboard/UpdatePerformerAssessment">
                        <input type="hidden" asp-for="Id" />
                        <input type="hidden" asp-for="Username" />
                        <input type="hidden" asp-for="AssessmentType" />
                        <input type="hidden" asp-for="Title" />

                        <div class="card">
                            <div class="card-header">
                                <h5><i class="bi bi-person-badge"></i> Supervisor Section</h5>
                                @if (ViewBag.CurrentRole == "supervisor" || ViewBag.CurrentRole == "advisor" || ViewBag.CurrentRole == "admin")
                                {
                                    <small class="text-muted">You can edit this section</small>
                                }
                                else
                                {
                                    <small class="text-muted">View-only for your role</small>
                                }
                            </div>
                            <div class="card-body">
                                <!-- Supervisor section follows Field-Level Permissions Pattern EXACTLY like TestPractice2 -->
                                <div class="mb-3">
                                    <label asp-for="OverallAcceptable" class="form-label">Overall was this encounter acceptable or not acceptable?</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" asp-for="OverallAcceptable" value="true" id="acceptable"
                                               disabled="@(!ViewBag.CanEditSupervisor)" />
                                        <label class="form-check-label" for="acceptable">
                                            Acceptable
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" asp-for="OverallAcceptable" value="false" id="notAcceptable"
                                               disabled="@(!ViewBag.CanEditSupervisor)" />
                                        <label class="form-check-label" for="notAcceptable">
                                            Not Acceptable
                                        </label>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label asp-for="SupervisorActionPlan" class="form-label">Overall comment on the encounter and provide an agreed action plan (if needed). It is useful to include any resources the performer could reference.</label>
                                    <textarea asp-for="SupervisorActionPlan" class="form-control" rows="6"
                                              placeholder="Provide your overall comments on the encounter and include an agreed action plan if needed. Consider including any useful resources or references for the performer..."
                                              readonly="@(!ViewBag.CanEditSupervisor)"></textarea>
                                </div>

                                <!-- Field-Level Permissions Pattern: Conditional Submit Button - EXACTLY like TestPractice2 -->
                                <div class="mt-4">
                                    @if (ViewBag.CanEditSupervisor && Model.IsPerformerSubmitted && !Model.IsSupervisorCompleted)
                                    {
                                        <button type="submit" name="isSupervisorCompletion" value="true" class="btn btn-success">
                                            <i class="bi bi-check-circle"></i> Complete Assessment
                                        </button>
                                    }
                                    else if (!Model.IsPerformerSubmitted)
                                    {
                                        <div class="alert alert-warning">
                                            <i class="bi bi-clock"></i> This section will be enabled after the performer submits their assessment.
                                        </div>
                                    }
                                    else if (Model.IsSupervisorCompleted)
                                    {
                                        <div class="alert alert-success">
                                            <i class="bi bi-check-circle"></i> 
                                            Assessment completed by @Model.CompletedBySupervisor on @Model.SupervisorCompletedAt?.ToString("MMMM dd, yyyy 'at' h:mm tt")
                                        </div>
                                    }
                                    else if (!ViewBag.CanEditSupervisor)
                                    {
                                        <div class="alert alert-info">
                                            <i class="bi bi-info-circle"></i> Only supervisors/advisors can complete this section.
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
