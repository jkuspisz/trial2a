@model SimpleGateway.Models.WorkBasedAssessmentModel
@{
    ViewData["Title"] = "Edit Work Based Assessment";
    ViewBag.ActiveSection = "WorkBasedAssessments";
}

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar Navigation -->
        <div class="col-md-3">
            <ul class="list-group">
                <li class="list-group-item @(ViewBag.ActiveSection == "Dashboard" ? "active" : "")">
                    <a href="/Dashboard/ViewPerformerDashboard?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "Dashboard" ? "color: white;" : "")">
                        <i class="bi bi-speedometer2"></i> Dashboard Overview
                    </a>
                </li>
                <li class="list-group-item @(ViewBag.ActiveSection == "PerformerDetails" ? "active" : "")">
                    <a href="/Dashboard/PerformerDetails?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "PerformerDetails" ? "color: white;" : "")">Performer Details</a>
                </li>
                <li class="list-group-item @(ViewBag.ActiveSection == "TestPractice" ? "active" : "")">
                    <a href="/Dashboard/TestPractice?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "TestPractice" ? "color: white;" : "")">Test Practice</a>
                </li>
                <li class="list-group-item @(ViewBag.ActiveSection == "TestPractice2" ? "active" : "")">
                    <a href="/Dashboard/TestPractice2?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "TestPractice2" ? "color: white;" : "")">Test Practice 2</a>
                </li>
                <li class="list-group-item @(ViewBag.ActiveSection == "Uploads" ? "active" : "")">
                    <a href="/Dashboard/Uploads?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "Uploads" ? "color: white;" : "")">Uploads</a>
                </li>
                <li class="list-group-item @(ViewBag.ActiveSection == "StructuredConversation" ? "active" : "")">
                    <a href="/Dashboard/StructuredConversation?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "StructuredConversation" ? "color: white;" : "")">Structured Conversation</a>
                </li>
                <li class="list-group-item @(ViewBag.ActiveSection == "AgreementTerms" ? "active" : "")">
                    <a href="/Dashboard/AgreementTerms?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "AgreementTerms" ? "color: white;" : "")">Agreement Terms</a>
                </li>
                <li class="list-group-item @(ViewBag.ActiveSection == "WorkBasedAssessments" ? "active" : "")">
                    <a href="/Dashboard/WorkBasedAssessments?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "WorkBasedAssessments" ? "color: white;" : "")">Work Based Assessments</a>
                </li>
                <li class="list-group-item @(ViewBag.ActiveSection == "CPD" ? "active" : "")">
                    <a href="/Dashboard/CPD?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "CPD" ? "color: white;" : "")">CPD</a>
                </li>
                <li class="list-group-item @(ViewBag.ActiveSection == "MSF" ? "active" : "")">
                    <a href="/Dashboard/MSF?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "MSF" ? "color: white;" : "")">MSF</a>
                </li>
                <li class="list-group-item @(ViewBag.ActiveSection == "PSQ" ? "active" : "")">
                    <a href="/Dashboard/PSQ?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "PSQ" ? "color: white;" : "")">PSQ</a>
                </li>
                <li class="list-group-item @(ViewBag.ActiveSection == "ClinicalNoteAudit" ? "active" : "")">
                    <a href="/Dashboard/ClinicalNoteAudit?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "ClinicalNoteAudit" ? "color: white;" : "")">Clinical Note Audit</a>
                </li>
                <li class="list-group-item @(ViewBag.ActiveSection == "HelpGuidance" ? "active" : "")">
                    <a href="/Dashboard/HelpGuidance?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "HelpGuidance" ? "color: white;" : "")">Help & Guidance</a>
                </li>
                <li class="list-group-item @(ViewBag.ActiveSection == "FinalSignOff" ? "active" : "")">
                    <a href="/Dashboard/FinalSignOff?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "FinalSignOff" ? "color: white;" : "")">Final Sign off</a>
                </li>
                @if (ViewBag.IsOwnDashboard == true)
                {
                    <li class="list-group-item"><a href="/Account/Logout">Logout</a></li>
                }
                else
                {
                    <li class="list-group-item"><a href="/Dashboard/Index">Back to List</a></li>
                }
            </ul>
        </div>

        <!-- Main Content Area -->
        <div class="col-md-9">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3>@Model.AssessmentType Assessment - @ViewBag.PerformerName</h3>
                            <span class="badge bg-@Model.GetStatusColor()">@Model.GetDisplayStatus()</span>
                        </div>
                        <a href="/Dashboard/WorkBasedAssessments?performerUsername=@ViewBag.PerformerUsername" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Back to List
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Success/Error Messages -->
                    @if (TempData["SuccessMessage"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            @TempData["SuccessMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }
                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            @TempData["ErrorMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    <!-- PERFORMER SECTION -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="bi bi-person"></i> Performer Section</h5>
                        </div>
                        <div class="card-body">
                            @if (ViewBag.CanEditPerformer && !Model.IsPerformerSubmitted)
                            {
                                <!-- Editable Performer Form -->
                                <form method="post" action="/Dashboard/UpdatePerformerAssessment">
                                    <input type="hidden" asp-for="Id" />
                                    <input type="hidden" asp-for="Username" />
                                    <input type="hidden" asp-for="AssessmentType" />
                                    <input type="hidden" asp-for="Title" />

                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label asp-for="AssessmentDate" class="form-label"></label>
                                            <input asp-for="AssessmentDate" class="form-control" type="text" 
                                                   placeholder="e.g., 2025-07-29 or July 29, 2025" 
                                                   value="@(Model.AssessmentDate?.ToString("yyyy-MM-dd"))" />
                                            <small class="form-text text-muted">Enter date in YYYY-MM-DD format</small>
                                        </div>
                                        <div class="col-md-6">
                                            <label asp-for="ClinicalArea" class="form-label"></label>
                                            <input asp-for="ClinicalArea" class="form-control" placeholder="e.g., Emergency Department, Outpatient Clinic" />
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label asp-for="ProcedureDetails" class="form-label"></label>
                                        <textarea asp-for="ProcedureDetails" class="form-control" rows="4" 
                                                  placeholder="Describe the procedure, case, or clinical scenario in detail..."></textarea>
                                    </div>

                                    <div class="mb-3">
                                        <label asp-for="LearningObjectives" class="form-label"></label>
                                        <textarea asp-for="LearningObjectives" class="form-control" rows="3"
                                                  placeholder="What were your specific learning objectives for this assessment?"></textarea>
                                    </div>

                                    <div class="mb-3">
                                        <label asp-for="PerformerComments" class="form-label"></label>
                                        <textarea asp-for="PerformerComments" class="form-control" rows="4"
                                                  placeholder="Your self-assessment comments and reflections..."></textarea>
                                    </div>

                                    <div class="mb-3">
                                        <label asp-for="AreasForDevelopment" class="form-label"></label>
                                        <textarea asp-for="AreasForDevelopment" class="form-control" rows="3"
                                                  placeholder="Areas you identified for further development or improvement..."></textarea>
                                    </div>

                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-save"></i> Save Changes
                                        </button>
                                        <button type="button" class="btn btn-success" onclick="submitPerformerAssessment()">
                                            <i class="bi bi-check-circle"></i> Submit for Supervisor Review
                                        </button>
                                    </div>
                                </form>

                                <script>
                                    function submitPerformerAssessment() {
                                        if (confirm('Are you sure you want to submit this assessment? You will not be able to edit it after submission.')) {
                                            var form = document.createElement('form');
                                            form.method = 'POST';
                                            form.action = '/Dashboard/SubmitPerformerAssessment';
                                            
                                            var input = document.createElement('input');
                                            input.type = 'hidden';
                                            input.name = 'id';
                                            input.value = '@Model.Id';
                                            form.appendChild(input);
                                            
                                            document.body.appendChild(form);
                                            form.submit();
                                        }
                                    }

                                    // DEBUG: Add event listeners to detect form field changes
                                    document.addEventListener('DOMContentLoaded', function() {
                                        const assessmentDateInput = document.querySelector('input[name="AssessmentDate"]');
                                        const allInputs = document.querySelectorAll('input[type="text"], textarea');
                                        
                                        if (assessmentDateInput) {
                                            assessmentDateInput.addEventListener('change', function() {
                                                console.log('DEBUG: AssessmentDate changed to:', this.value);
                                                
                                                // Check if any other fields got cleared
                                                setTimeout(() => {
                                                    allInputs.forEach(input => {
                                                        if (input !== assessmentDateInput && input.value === '') {
                                                            console.log('WARNING: Field was cleared:', input.name || input.id);
                                                        }
                                                    });
                                                }, 100);
                                            });
                                        }
                                    });
                                </script>
                            }
                            else
                            {
                                <!-- Read-only Performer Section -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <strong>Assessment Date:</strong>
                                        <p>@(Model.AssessmentDate?.ToString("MMMM dd, yyyy") ?? "Not specified")</p>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Clinical Area/Setting:</strong>
                                        <p>@(Model.ClinicalArea ?? "Not specified")</p>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <strong>Procedure/Case Details:</strong>
                                    <p class="border p-3 bg-light">@(Model.ProcedureDetails ?? "Not provided")</p>
                                </div>

                                <div class="mb-3">
                                    <strong>Learning Objectives:</strong>
                                    <p class="border p-3 bg-light">@(Model.LearningObjectives ?? "Not provided")</p>
                                </div>

                                <div class="mb-3">
                                    <strong>Self-Assessment Comments:</strong>
                                    <p class="border p-3 bg-light">@(Model.PerformerComments ?? "Not provided")</p>
                                </div>

                                <div class="mb-3">
                                    <strong>Areas for Development:</strong>
                                    <p class="border p-3 bg-light">@(Model.AreasForDevelopment ?? "Not provided")</p>
                                </div>

                                @if (Model.IsPerformerSubmitted)
                                {
                                    <div class="alert alert-success">
                                        <i class="bi bi-check-circle"></i> 
                                        Submitted by performer on @Model.PerformerSubmittedAt?.ToString("MMMM dd, yyyy 'at' h:mm tt")
                                    </div>
                                }
                            }
                        </div>
                    </div>

                    <!-- SUPERVISOR SECTION - Following Field-Level Permissions Pattern -->
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="bi bi-person-badge"></i> Supervisor Section</h5>
                            @if (ViewBag.CurrentRole == "supervisor" || ViewBag.CurrentRole == "advisor" || ViewBag.CurrentRole == "admin")
                            {
                                <small class="text-muted">You can edit this section</small>
                            }
                            else
                            {
                                <small class="text-muted">View-only for your role</small>
                            }
                        </div>
                        <div class="card-body">
                            <!-- Supervisor section is ALWAYS visible but conditionally editable -->
                            <form method="post" action="/Dashboard/CompleteSupervisorAssessment">
                                <input type="hidden" asp-for="Id" />

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label asp-for="SupervisorName" class="form-label"></label>
                                        <input asp-for="SupervisorName" class="form-control" 
                                               placeholder="Full name of supervisor"
                                               readonly="@(!ViewBag.CanEditSupervisor)" />
                                    </div>
                                    <div class="col-md-6">
                                        <label asp-for="SupervisorRole" class="form-label"></label>
                                        <input asp-for="SupervisorRole" class="form-control" 
                                               placeholder="e.g., Consultant, Senior Registrar"
                                               readonly="@(!ViewBag.CanEditSupervisor)" />
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label asp-for="OverallRating" class="form-label"></label>
                                    <select asp-for="OverallRating" class="form-select" 
                                            disabled="@(!ViewBag.CanEditSupervisor)">
                                        <option value="">Select overall performance rating</option>
                                        <option value="Excellent">Excellent</option>
                                        <option value="Good">Good</option>
                                        <option value="Satisfactory">Satisfactory</option>
                                        <option value="Needs Improvement">Needs Improvement</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label asp-for="SkillsAssessment" class="form-label"></label>
                                    <textarea asp-for="SkillsAssessment" class="form-control" rows="4"
                                              placeholder="Detailed assessment of specific skills demonstrated..."
                                              readonly="@(!ViewBag.CanEditSupervisor)"></textarea>
                                </div>

                                <div class="mb-3">
                                    <label asp-for="SupervisorComments" class="form-label"></label>
                                    <textarea asp-for="SupervisorComments" class="form-control" rows="4"
                                              placeholder="Overall comments on performance and areas observed..."
                                              readonly="@(!ViewBag.CanEditSupervisor)"></textarea>
                                </div>

                                <div class="mb-3">
                                    <label asp-for="Recommendations" class="form-label"></label>
                                    <textarea asp-for="Recommendations" class="form-control" rows="3"
                                              placeholder="Recommendations for continued development..."
                                              readonly="@(!ViewBag.CanEditSupervisor)"></textarea>
                                </div>

                                <div class="mb-3">
                                    <label asp-for="ActionPlan" class="form-label"></label>
                                    <textarea asp-for="ActionPlan" class="form-control" rows="3"
                                              placeholder="Specific action plan for improvement or next steps..."
                                              readonly="@(!ViewBag.CanEditSupervisor)"></textarea>
                                </div>

                                <!-- Conditional Submit Button following your pattern -->
                                <div class="mt-4">
                                    @if (ViewBag.CanEditSupervisor && Model.IsPerformerSubmitted && !Model.IsSupervisorCompleted)
                                    {
                                        <button type="submit" class="btn btn-success">
                                            <i class="bi bi-check-circle"></i> Complete Assessment
                                        </button>
                                    }
                                    else if (!Model.IsPerformerSubmitted)
                                    {
                                        <div class="alert alert-warning">
                                            <i class="bi bi-clock"></i> This section will be enabled after the performer submits their assessment.
                                        </div>
                                    }
                                    else if (Model.IsSupervisorCompleted)
                                    {
                                        <div class="alert alert-success">
                                            <i class="bi bi-check-circle"></i> 
                                            Assessment completed by @Model.CompletedBySupervisor on @Model.SupervisorCompletedAt?.ToString("MMMM dd, yyyy 'at' h:mm tt")
                                        </div>
                                    }
                                    else if (!ViewBag.CanEditSupervisor)
                                    {
                                        <div class="alert alert-info">
                                            <i class="bi bi-info-circle"></i> Only supervisors/advisors can complete this section.
                                        </div>
                                    }
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
