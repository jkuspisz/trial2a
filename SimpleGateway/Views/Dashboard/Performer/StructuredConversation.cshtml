@model SimpleGateway.Models.StructuredConversationModel

@{
    ViewBag.Title = "Structured Conversation - " + ViewBag.PerformerName;
    Layout = "_Layout";
}

<div class="row">
    <div class="col-3">
        <ul class="list-group">
            <li class="list-group-item @(ViewBag.ActiveSection == "Dashboard" ? "active" : "")">
                <a href="/Dashboard/ViewPerformerDashboard?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "Dashboard" ? "color: white;" : "")">
                    <i class="bi bi-speedometer2"></i> Dashboard Overview
                </a>
            </li>
            <li class="list-group-item @(ViewBag.ActiveSection == "PerformerDetails" ? "active" : "")">
                <a href="/Dashboard/PerformerDetails?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "PerformerDetails" ? "color: white;" : "")">Performer Details</a>
            </li>
            <li class="list-group-item @(ViewBag.ActiveSection == "TestPractice" ? "active" : "")">
                <a href="/Dashboard/TestPractice?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "TestPractice" ? "color: white;" : "")">Test Practice</a>
            </li>
            <li class="list-group-item @(ViewBag.ActiveSection == "TestPractice2" ? "active" : "")">
                <a href="/Dashboard/TestPractice2?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "TestPractice2" ? "color: white;" : "")">Test Practice 2</a>
            </li>
            <li class="list-group-item @(ViewBag.ActiveSection == "Uploads" ? "active" : "")">
                <a href="/Dashboard/Uploads?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "Uploads" ? "color: white;" : "")">Uploads</a>
            </li>
            <li class="list-group-item @(ViewBag.ActiveSection == "StructuredConversation" ? "active" : "")">
                <a href="/Dashboard/StructuredConversation?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "StructuredConversation" ? "color: white;" : "")">Structured Conversation</a>
            </li>
            <li class="list-group-item @(ViewBag.ActiveSection == "AgreementTerms" ? "active" : "")">
                <a href="/Dashboard/AgreementTerms?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "AgreementTerms" ? "color: white;" : "")">Agreement Terms</a>
            </li>
            <li class="list-group-item @(ViewBag.ActiveSection == "WorkBasedAssessments" ? "active" : "")">
                <a href="/Dashboard/WorkBasedAssessments?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "WorkBasedAssessments" ? "color: white;" : "")">Work Based Assessments</a>
            </li>
            <li class="list-group-item @(ViewBag.ActiveSection == "CPD" ? "active" : "")">
                <a href="/Dashboard/CPD?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "CPD" ? "color: white;" : "")">CPD</a>
            </li>
            <li class="list-group-item @(ViewBag.ActiveSection == "MSF" ? "active" : "")">
                <a href="@Url.Action("Index", "MSF", new { performerUsername = ViewBag.PerformerUsername })" style="@(ViewBag.ActiveSection == "MSF" ? "color: white;" : "")">
                    <i class="fas fa-comments"></i> MSF Assessment
                </a>
            </li>
            <li class="list-group-item @(ViewBag.ActiveSection == "PSQ" ? "active" : "")">
                <a href="/Dashboard/PSQ?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "PSQ" ? "color: white;" : "")">PSQ</a>
            </li>
            <li class="list-group-item @(ViewBag.ActiveSection == "ClinicalNoteAudit" ? "active" : "")">
                <a href="/Dashboard/ClinicalNoteAudit?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "ClinicalNoteAudit" ? "color: white;" : "")">Clinical Note Audit</a>
            </li>
            <li class="list-group-item @(ViewBag.ActiveSection == "HelpGuidance" ? "active" : "")">
                <a href="/Dashboard/HelpGuidance?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "HelpGuidance" ? "color: white;" : "")">Help & Guidance</a>
            </li>
            <li class="list-group-item @(ViewBag.ActiveSection == "FinalSignOff" ? "active" : "")">
                <a href="/Dashboard/FinalSignOff?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "FinalSignOff" ? "color: white;" : "")">Final Sign off</a>
            </li>
            @if (ViewBag.IsOwnDashboard == true)
            {
                <li class="list-group-item"><a href="/Account/Logout">Logout</a></li>
            }
            else
            {
                <li class="list-group-item"><a href="/Dashboard/Index">Back to List</a></li>
            }
        </ul>
    </div>
    
    <div class="col-9">
        <div class="card">
            <div class="card-header" style="background-color: #e8f5e8; color: #2d5a2d;">
                <h4>Structured Conversation - @ViewBag.PerformerName</h4>
                <div class="alert alert-primary mb-0 mt-2">
                    <h6><strong>Instructions for Advisor:</strong></h6>
                    <p class="mb-0">This form is designed for advisors to document key discussion points and assessments from structured conversations with performers. Please complete all relevant sections based on your interaction and evaluation.</p>
                </div>
                
                @if (!ViewBag.CanEditAdvisorFields)
                {
                    <div class="alert alert-info mt-2 mb-0">
                        <i class="bi bi-eye"></i> <strong>View-Only Access:</strong> 
                        This structured conversation information can only be edited by advisors and administrators. 
                        You can view all information but cannot make changes.
                    </div>
                }
                else
                {
                    <div class="alert alert-success mt-2 mb-0">
                        <i class="bi bi-pencil-square"></i> <strong>Edit Access:</strong> 
                        You have permission to edit and save structured conversation information for this performer.
                    </div>
                }
            </div>
            <div class="card-body">
                @if (TempData["SuccessMessage"] != null)
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        @TempData["SuccessMessage"]
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                }
                
                @if (TempData["ErrorMessage"] != null)
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        @TempData["ErrorMessage"]
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                }

                <form asp-action="StructuredConversation" method="post">
                    <!-- CRITICAL: Hidden field ensures data ownership - advisor edits performer's data -->
                    <input type="hidden" asp-for="Username" value="@ViewBag.PerformerUsername" />
                    
                    <!-- Clinical Experience Summary -->
                    <div class="card mb-4">
                        <div class="card-header" style="background-color: #f8f9fa; color: #495057;">
                            <h5 class="mb-0">
                                <i class="bi bi-clipboard-data"></i> 1. Summary of Clinical Experience
                            </h5>
                        </div>
                        <div class="card-body">
                            @if (ViewBag.CanEditAdvisorFields)
                            {
                                <div class="mb-3">
                                    <textarea asp-for="ClinicalExperienceSummary" class="form-control" rows="6" 
                                              placeholder="Provide a comprehensive summary of the performer's clinical experience, including areas of strength, relevant background, and overall clinical competency observed..."></textarea>
                                    <span asp-validation-for="ClinicalExperienceSummary" class="text-danger"></span>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-light border-start border-info border-4 py-3">
                                    @if (!string.IsNullOrEmpty(Model.ClinicalExperienceSummary))
                                    {
                                        @Html.Raw(Model.ClinicalExperienceSummary.Replace("\n", "<br/>"))
                                    }
                                    else
                                    {
                                        <em class="text-muted">No clinical experience summary provided yet.</em>
                                    }
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Development Needs -->
                    <div class="card mb-4">
                        <div class="card-header" style="background-color: #fff3cd; color: #856404;">
                            <h5 class="mb-0">
                                <i class="bi bi-arrow-up-circle"></i> 2. Development Needs Identified (if any)
                            </h5>
                        </div>
                        <div class="card-body">
                            @if (ViewBag.CanEditAdvisorFields)
                            {
                                <div class="mb-3">
                                    <textarea asp-for="DevelopmentNeeds" class="form-control" rows="6" 
                                              placeholder="Identify any specific development needs, areas for improvement, training requirements, or skills gaps that should be addressed. If no development needs are identified, please state 'No specific development needs identified at this time.'"></textarea>
                                    <span asp-validation-for="DevelopmentNeeds" class="text-danger"></span>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-light border-start border-warning border-4 py-3">
                                    @if (!string.IsNullOrEmpty(Model.DevelopmentNeeds))
                                    {
                                        @Html.Raw(Model.DevelopmentNeeds.Replace("\n", "<br/>"))
                                    }
                                    else
                                    {
                                        <em class="text-muted">No development needs assessment provided yet.</em>
                                    }
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Supervisor Summary -->
                    <div class="card mb-4">
                        <div class="card-header" style="background-color: #d1ecf1; color: #0c5460;">
                            <h5 class="mb-0">
                                <i class="bi bi-person-badge"></i> 3. Supporting Dentist/Supervisor Summary
                            </h5>
                            <small class="text-muted">Summary of application/suitability and/or advice given</small>
                        </div>
                        <div class="card-body">
                            @if (ViewBag.CanEditAdvisorFields)
                            {
                                <div class="mb-3">
                                    <textarea asp-for="SupervisorSummary" class="form-control" rows="6" 
                                              placeholder="Document the supporting dentist's or supervisor's assessment of the performer's application, suitability for the role, and any advice or recommendations provided during supervision..."></textarea>
                                    <span asp-validation-for="SupervisorSummary" class="text-danger"></span>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-light border-start border-info border-4 py-3">
                                    @if (!string.IsNullOrEmpty(Model.SupervisorSummary))
                                    {
                                        @Html.Raw(Model.SupervisorSummary.Replace("\n", "<br/>"))
                                    }
                                    else
                                    {
                                        <em class="text-muted">No supervisor summary provided yet.</em>
                                    }
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Advisor Comments -->
                    <div class="card mb-4">
                        <div class="card-header" style="background-color: #f8d7da; color: #721c24;">
                            <h5 class="mb-0">
                                <i class="bi bi-chat-text"></i> 4. Any Other Comments from Advisor
                            </h5>
                        </div>
                        <div class="card-body">
                            @if (ViewBag.CanEditAdvisorFields)
                            {
                                <div class="mb-3">
                                    <textarea asp-for="AdvisorComments" class="form-control" rows="6" 
                                              placeholder="Include any additional comments, observations, recommendations, or concerns that were not covered in the previous sections. This can include overall impressions, next steps, or any specific guidance provided..."></textarea>
                                    <span asp-validation-for="AdvisorComments" class="text-danger"></span>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-light border-start border-danger border-4 py-3">
                                    @if (!string.IsNullOrEmpty(Model.AdvisorComments))
                                    {
                                        @Html.Raw(Model.AdvisorComments.Replace("\n", "<br/>"))
                                    }
                                    else
                                    {
                                        <em class="text-muted">No additional advisor comments provided yet.</em>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                    
                    <!-- Submit Button -->
                    <div class="mt-4">
                        @if (ViewBag.CanEditAdvisorFields)
                        {
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-check-circle"></i> Save Structured Conversation
                            </button>
                        }
                        else
                        {
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> <strong>View-Only Access</strong><br/>
                                This structured conversation form can only be edited by advisors and administrators. 
                                You can view all the information but cannot make changes.
                            </div>
                        }
                        <a href="/Dashboard/Index" class="btn btn-secondary btn-lg ms-2">Back to Dashboard</a>
                    </div>
                </form>
                
                <div class="mt-4">
                    <div class="alert alert-info">
                        <h6><strong>Form Information:</strong></h6>
                        <p><strong>Purpose:</strong> This form captures structured conversation outcomes between advisors and performers to document assessment discussions and development planning.</p>
                        <p><strong>Access Control:</strong> Only advisors and administrators can edit this form. Other users can view the information for reference.</p>
                        <p><strong>Data Storage:</strong> Information is securely stored in the PostgreSQL database and is accessible to relevant assessment team members.</p>
                        <p><strong>Note:</strong> Please ensure all information provided is accurate and comprehensive as this forms part of the performer's assessment documentation.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}