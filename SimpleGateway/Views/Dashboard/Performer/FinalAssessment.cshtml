@model SimpleGateway.Models.FinalSignOffModel
@{
    ViewData["Title"] = "Final Assessment - Sign Off";
    ViewBag.ActiveSection = "FinalAssessment";
}

<style>
    .sidebar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px 0;
    }
    .nav-link {
        color: rgba(255, 255, 255, 0.8);
        padding: 12px 20px;
        margin: 2px 0;
        border-radius: 8px;
        transition: all 0.3s ease;
        text-decoration: none;
        display: block;
    }
    .nav-link:hover {
        color: white;
        background-color: rgba(255, 255, 255, 0.1);
        transform: translateX(5px);
    }
    .nav-link.active {
        color: white;
        background-color: rgba(255, 255, 255, 0.2);
        font-weight: 600;
    }
    .main-content {
        background-color: #f8f9fa;
        min-height: 100vh;
        padding: 30px;
    }
    .content-card {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
    }
    .declaration-card {
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        transition: all 0.3s ease;
    }
    .declaration-card.signed {
        border-color: #28a745;
        background-color: #f8fff9;
    }
    .declaration-card.pending {
        border-color: #ffc107;
        background-color: #fffdf0;
    }
    .declaration-card.disabled {
        border-color: #dee2e6;
        background-color: #f8f9fa;
        opacity: 0.7;
    }
    .declaration-text {
        font-size: 1.1rem;
        line-height: 1.6;
        margin-bottom: 20px;
        font-style: italic;
        color: #495057;
    }
    .signature-info {
        background-color: #e8f5e8;
        border: 1px solid #28a745;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
    }
    .signature-pending {
        background-color: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
    }
    .completion-banner {
        background: linear-gradient(45deg, #28a745, #20c997);
        color: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        margin-bottom: 30px;
    }
    .btn-declare {
        background: linear-gradient(45deg, #007bff, #0056b3);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    .btn-declare:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
    }
    .btn-declare:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
</style>

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar Navigation -->
        <div class="col-md-3 sidebar">
            <div class="text-center mb-4">
                <h4 class="text-white">@ViewBag.PerformerName Navigation</h4>
                <p class="text-white-50">Performance Management System</p>
            </div>
            
            <nav class="nav flex-column">
                <a href="/Dashboard/PerformerDashboard?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "Dashboard" ? "color: white;" : "")">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a href="/Dashboard/PerformerDetails?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "PerformerDetails" ? "color: white;" : "")">
                    <i class="fas fa-user"></i> Performer Details
                </a>
                <a href="/Dashboard/AgreementTerms?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "AgreementTerms" ? "color: white;" : "")">
                    <i class="fas fa-file-contract"></i> Agreement Terms
                </a>
                <a href="/Dashboard/WorkBasedAssessments?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "WorkBasedAssessments" ? "color: white;" : "")">
                    <i class="fas fa-clipboard-check"></i> Work Based Assessments
                </a>
                <a href="/Dashboard/TestPractice?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "TestPractice" ? "color: white;" : "")">
                    <i class="fas fa-flask"></i> Test Practice
                </a>
                <a href="/Dashboard/TestPractice2?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "TestPractice2" ? "color: white;" : "")">
                    <i class="fas fa-vial"></i> Test Practice 2
                </a>
                <a href="/Dashboard/StructuredConversation?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "StructuredConversation" ? "color: white;" : "")">
                    <i class="fas fa-comments"></i> Structured Conversation
                </a>
                <a href="/Dashboard/CPD?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "CPD" ? "color: white;" : "")">
                    <i class="fas fa-graduation-cap"></i> CPD
                </a>
                <a href="/Dashboard/Uploads?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "Uploads" ? "color: white;" : "")">
                    <i class="fas fa-upload"></i> Uploads
                </a>
                <a href="/Dashboard/MSF?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "MSF" ? "color: white;" : "")">
                    <i class="fas fa-users"></i> MSF
                </a>
                <a href="/Dashboard/PSQ?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "PSQ" ? "color: white;" : "")">
                    <i class="fas fa-heart"></i> PSQ Assessment
                </a>
                <a href="/Dashboard/ClinicalNoteAudit?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "ClinicalNoteAudit" ? "color: white;" : "")">
                    <i class="fas fa-file-medical-alt"></i> Clinical Note Audit
                </a>
                <a href="/Dashboard/PerformanceReview?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "PerformanceReview" ? "color: white;" : "")">
                    <i class="fas fa-chart-line"></i> Performance Review
                </a>
                <a href="/Dashboard/HelpGuidance?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "HelpGuidance" ? "color: white;" : "")">
                    <i class="fas fa-question-circle"></i> Help & Guidance
                </a>
                <a href="/Dashboard/FinalAssessment?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "FinalAssessment" ? "color: white;" : "")">
                    <i class="fas fa-trophy"></i> Final Assessment
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 main-content">
            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle"></i> @TempData["SuccessMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-triangle"></i> @TempData["ErrorMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            <div class="content-card">
                <div class="text-center mb-4">
                    <h2><i class="fas fa-trophy text-warning"></i> Final Assessment - Sign Off</h2>
                    <p class="text-muted">Complete the probationary period with all required declarations</p>
                </div>

                @if (Model.IsFullyCompleted)
                {
                    <div class="completion-banner">
                        <h3><i class="fas fa-check-circle"></i> Probationary Period Complete!</h3>
                        <p class="mb-0">All required declarations have been signed. The probationary flag has been removed.</p>
                    </div>
                }

                <!-- Declaration 1: Performer -->
                <div class="declaration-card @(Model.PerformerDeclarationSigned ? "signed" : (ViewBag.CanSignPerformerDeclaration ? "pending" : "disabled"))">
                    <h4><i class="fas fa-user text-primary"></i> Performer Declaration</h4>
                    <div class="declaration-text">
                        "I declare I have completed all parts needed as stated in the agreement terms and any extra tasks required by my supervisor/supporting dentist and dental advisor."
                    </div>

                    @if (Model.PerformerDeclarationSigned)
                    {
                        <div class="signature-info">
                            <strong><i class="fas fa-check-circle text-success"></i> Signed by:</strong> @Model.PerformerSignedBy<br>
                            <strong><i class="fas fa-clock text-success"></i> Date & Time:</strong> @Model.PerformerSignedAt?.ToString("dddd, MMMM dd, yyyy 'at' h:mm tt")
                        </div>
                    }
                    else if (ViewBag.CanSignPerformerDeclaration)
                    {
                        <div class="signature-pending">
                            <i class="fas fa-hourglass-half"></i> <strong>Ready for your signature</strong>
                        </div>
                        <form method="post" action="/Dashboard/SignDeclaration" style="display: inline;">
                            <input type="hidden" name="performerUsername" value="@ViewBag.PerformerUsername" />
                            <input type="hidden" name="declarationType" value="performer" />
                            <button type="submit" class="btn btn-declare">
                                <i class="fas fa-pen"></i> I Declare
                            </button>
                        </form>
                    }
                    else
                    {
                        <div class="signature-pending">
                            @if (ViewBag.CurrentUserRole == "performer" && ViewBag.CurrentUser == ViewBag.PerformerUsername)
                            {
                                <i class="fas fa-info-circle"></i> <strong>Already signed</strong>
                            }
                            else
                            {
                                <i class="fas fa-lock"></i> <strong>Waiting for performer to sign</strong>
                            }
                        </div>
                    }
                </div>

                <!-- Declaration 2: Supervisor -->
                <div class="declaration-card @(Model.SupervisorDeclarationSigned ? "signed" : (ViewBag.CanSignSupervisorDeclaration ? "pending" : "disabled"))">
                    <h4><i class="fas fa-user-tie text-info"></i> Supervisor Declaration</h4>
                    <div class="declaration-text">
                        "I declare the agreement terms are fulfilled and I have no concerns to raise."
                    </div>

                    @if (Model.SupervisorDeclarationSigned)
                    {
                        <div class="signature-info">
                            <strong><i class="fas fa-check-circle text-success"></i> Signed by:</strong> @Model.SupervisorSignedBy<br>
                            <strong><i class="fas fa-clock text-success"></i> Date & Time:</strong> @Model.SupervisorSignedAt?.ToString("dddd, MMMM dd, yyyy 'at' h:mm tt")
                        </div>
                    }
                    else if (ViewBag.CanSignSupervisorDeclaration)
                    {
                        <div class="signature-pending">
                            <i class="fas fa-hourglass-half"></i> <strong>Ready for supervisor signature</strong>
                        </div>
                        <form method="post" action="/Dashboard/SignDeclaration" style="display: inline;">
                            <input type="hidden" name="performerUsername" value="@ViewBag.PerformerUsername" />
                            <input type="hidden" name="declarationType" value="supervisor" />
                            <button type="submit" class="btn btn-declare">
                                <i class="fas fa-pen"></i> I Declare
                            </button>
                        </form>
                    }
                    else
                    {
                        <div class="signature-pending">
                            <i class="fas fa-lock"></i> <strong>Waiting for supervisor to sign</strong>
                        </div>
                    }
                </div>

                <!-- Declaration 3: Advisor -->
                <div class="declaration-card @(Model.AdvisorDeclarationSigned ? "signed" : (ViewBag.CanSignAdvisorDeclaration ? "pending" : "disabled"))">
                    <h4><i class="fas fa-user-graduate text-success"></i> Advisor Declaration</h4>
                    <div class="declaration-text">
                        "I declare the agreement terms are fulfilled and the probationary flag be removed."
                    </div>

                    @if (Model.AdvisorDeclarationSigned)
                    {
                        <div class="signature-info">
                            <strong><i class="fas fa-check-circle text-success"></i> Signed by:</strong> @Model.AdvisorSignedBy<br>
                            <strong><i class="fas fa-clock text-success"></i> Date & Time:</strong> @Model.AdvisorSignedAt?.ToString("dddd, MMMM dd, yyyy 'at' h:mm tt")
                        </div>
                    }
                    else if (ViewBag.CanSignAdvisorDeclaration)
                    {
                        <div class="signature-pending">
                            <i class="fas fa-hourglass-half"></i> <strong>Ready for advisor signature</strong>
                        </div>
                        <form method="post" action="/Dashboard/SignDeclaration" style="display: inline;">
                            <input type="hidden" name="performerUsername" value="@ViewBag.PerformerUsername" />
                            <input type="hidden" name="declarationType" value="advisor" />
                            <button type="submit" class="btn btn-declare">
                                <i class="fas fa-pen"></i> I Declare
                            </button>
                        </form>
                    }
                    else
                    {
                        <div class="signature-pending">
                            <i class="fas fa-lock"></i> <strong>Waiting for advisor to sign</strong>
                        </div>
                    }
                </div>

                <div class="mt-4 text-center">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> 
                        All declarations must be completed in sequence. Only authorized users can sign their respective declarations.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap and FontAwesome -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
