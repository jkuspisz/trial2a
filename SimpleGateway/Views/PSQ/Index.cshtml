@model SimpleGateway.Models.PSQResultsDto
@{
    ViewData["Title"] = "Patient Satisfaction Questionnaire (PSQ)";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var showCreateForm = ViewBag.ShowCreateForm ?? false;
    var performerUsername = ViewBag.PerformerUsername ?? "";
    var performerName = ViewBag.PerformerName ?? "";
}

<div class="row">
    <div class="col-3">
        <ul class="list-group">
            <li class="list-group-item @(ViewBag.ActiveSection == "Dashboard" ? "active" : "")">
                <a href="/Dashboard/ViewPerformerDashboard?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "Dashboard" ? "color: white;" : "")">
                    <i class="bi bi-speedometer2"></i> Dashboard Overview
                </a>
            </li>
            <li class="list-group-item @(ViewBag.ActiveSection == "PerformerDetails" ? "active" : "")">
                <a href="/Dashboard/PerformerDetails?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "PerformerDetails" ? "color: white;" : "")">Performer Details</a>
            </li>
            <li class="list-group-item @(ViewBag.ActiveSection == "TestPractice" ? "active" : "")">
                <a href="/Dashboard/TestPractice?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "TestPractice" ? "color: white;" : "")">Test Practice</a>
            </li>
            <li class="list-group-item @(ViewBag.ActiveSection == "TestPractice2" ? "active" : "")">
                <a href="/Dashboard/TestPractice2?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "TestPractice2" ? "color: white;" : "")">Test Practice 2</a>
            </li>
            <li class="list-group-item @(ViewBag.ActiveSection == "Uploads" ? "active" : "")">
                <a href="/Dashboard/Uploads?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "Uploads" ? "color: white;" : "")">Uploads</a>
            </li>
            <li class="list-group-item @(ViewBag.ActiveSection == "StructuredConversation" ? "active" : "")">
                <a href="/Dashboard/StructuredConversation?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "StructuredConversation" ? "color: white;" : "")">Structured Conversation</a>
            </li>
            <li class="list-group-item @(ViewBag.ActiveSection == "AgreementTerms" ? "active" : "")">
                <a href="/Dashboard/AgreementTerms?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "AgreementTerms" ? "color: white;" : "")">Agreement Terms</a>
            </li>
            <li class="list-group-item @(ViewBag.ActiveSection == "WorkBasedAssessments" ? "active" : "")">
                <a href="/Dashboard/WorkBasedAssessments?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "WorkBasedAssessments" ? "color: white;" : "")">Work Based Assessments</a>
            </li>
            <li class="list-group-item @(ViewBag.ActiveSection == "CPD" ? "active" : "")">
                <a href="/Dashboard/CPD?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "CPD" ? "color: white;" : "")">CPD</a>
            </li>
            <li class="list-group-item @(ViewBag.ActiveSection == "MSF" ? "active" : "")">
                <a href="@Url.Action("Index", "MSF", new { performerUsername = ViewBag.PerformerUsername })" style="@(ViewBag.ActiveSection == "MSF" ? "color: white;" : "")">
                    <i class="fas fa-comments"></i> MSF Assessment
                </a>
            </li>
            <li class="list-group-item @(ViewBag.ActiveSection == "PSQ" ? "active" : "")">
                <a href="@Url.Action("Index", "PSQ", new { performerUsername = ViewBag.PerformerUsername })" style="@(ViewBag.ActiveSection == "PSQ" ? "color: white;" : "")">
                    <i class="fas fa-star"></i> PSQ Assessment
                </a>
            </li>
            <li class="list-group-item @(ViewBag.ActiveSection == "ClinicalNoteAudit" ? "active" : "")">
                <a href="/Dashboard/ClinicalNoteAudit?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "ClinicalNoteAudit" ? "color: white;" : "")">Clinical Note Audit</a>
            </li>
            <li class="list-group-item @(ViewBag.ActiveSection == "HelpGuidance" ? "active" : "")">
                <a href="/Dashboard/HelpGuidance?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "HelpGuidance" ? "color: white;" : "")">Help & Guidance</a>
            </li>
            <li class="list-group-item @(ViewBag.ActiveSection == "FinalSignOff" ? "active" : "")">
                <a href="/Dashboard/FinalSignOff?performerUsername=@ViewBag.PerformerUsername" style="@(ViewBag.ActiveSection == "FinalSignOff" ? "color: white;" : "")">Final Sign off</a>
            </li>
        </ul>
    </div>
    <div class="col-9">
        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
        }

        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success">@TempData["SuccessMessage"]</div>
        }

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="fas fa-star text-warning"></i> Patient Satisfaction Questionnaire (PSQ)
                </h4>
                <span class="badge bg-info">@performerName</span>
            </div>
            <div class="card-body">
                @if (!Model.HasActiveQuestionnaire)
                {
                    <div class="alert alert-info">
                        <h5><i class="fas fa-info-circle"></i> No Active PSQ</h5>
                        <p>Create a PSQ questionnaire to start collecting patient feedback about your dental services.</p>
                        <p><strong>PSQ collects patient feedback on:</strong></p>
                        <ul>
                            <li>Communication and patient care quality</li>
                            <li>Treatment explanations and decision involvement</li>
                            <li>Professional manner and trust</li>
                            <li>Overall patient experience</li>
                        </ul>
                    </div>

                    <form asp-action="CreateQuestionnaire" method="post">
                        <input type="hidden" name="performerUsername" value="@performerUsername" />
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-plus"></i> Create PSQ Link
                        </button>
                    </form>
                }
                else
                {
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0"><i class="fas fa-link"></i> Share PSQ</h5>
                                </div>
                                <div class="card-body">
                                    <p><strong>Unique Code:</strong> <code>@Model.UniqueCode</code></p>
                                    <p><strong>Feedback URL:</strong></p>
                                    <div class="input-group mb-3">
                                        <input type="text" class="form-control" value="@Model.FeedbackUrl" readonly id="feedbackUrl">
                                        <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard()">
                                            <i class="fas fa-copy"></i> Copy
                                        </button>
                                    </div>
                                    
                                    <div class="text-center mt-3">
                                        <p><strong>QR Code:</strong></p>
                                        <img src="@Url.Action("GenerateQRCode", "PSQ", new { code = Model.UniqueCode })" 
                                             alt="PSQ QR Code" class="img-fluid" style="max-width: 200px;">
                                        <p class="small text-muted mt-2">Patients can scan this QR code to provide feedback</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Response Summary</h5>
                                </div>
                                <div class="card-body">
                                    <h3 class="text-center">@Model.TotalResponses</h3>
                                    <p class="text-center text-muted">Patient responses received</p>
                                    
                                    @if (Model.TotalResponses > 0)
                                    {
                                        <a href="@Url.Action("Results", "PSQ", new { performerUsername = performerUsername })" 
                                           class="btn btn-info w-100">
                                            <i class="fas fa-chart-line"></i> View Detailed Results
                                        </a>
                                    }
                                    else
                                    {
                                        <div class="alert alert-light">
                                            <small><i class="fas fa-info-circle"></i> Share the link above with your patients to start collecting feedback.</small>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    @if (Model.TotalResponses > 0)
                    {
                        <div class="mt-4">
                            <h5><i class="fas fa-chart-bar"></i> Quick Overview</h5>
                            <div class="row">
                                @foreach (var avg in Model.QuestionAverages.Take(6))
                                {
                                    <div class="col-md-6 mb-2">
                                        <div class="d-flex justify-content-between">
                                            <span class="small">@avg.Key:</span>
                                            <span class="badge bg-@(avg.Value >= 3 ? "success" : avg.Value >= 0 ? "warning" : "danger")">
                                                @avg.Value.ToString("F1")
                                            </span>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</div>

<script>
function copyToClipboard() {
    var copyText = document.getElementById("feedbackUrl");
    copyText.select();
    copyText.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(copyText.value);
    
    // Show feedback
    var button = event.target.closest('button');
    var originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check"></i> Copied!';
    button.classList.add('btn-success');
    button.classList.remove('btn-outline-secondary');
    
    setTimeout(function() {
        button.innerHTML = originalText;
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-secondary');
    }, 2000);
}
</script>
